<div class="module-card">
  <h3>📈 KPI Dashboard</h3>
  <div class="form-row">
    <input id="kpi_date" type="date" />
    <input id="kpi_sales" type="number" placeholder="Sales" />
    <input id="kpi_profit" type="number" placeholder="Profit" />
    <input id="kpi_new" type="number" placeholder="New customers" />
    <button id="addKPI" class="btn">➕ Add</button>
  </div>

  <canvas id="kpiChart" height="100" style="margin-top:12px"></canvas>
  <div class="module-actions">
    <button id="exportKPI" class="btn">⬇️ Export CSV</button>
  </div>
</div>

<script>
(function init_kpi(){
  let rows = JSON.parse(localStorage.getItem('mod_kpi')||'[]');
  const ctx = document.getElementById('kpiChart').getContext('2d');
  let chart;

  function renderChart(){
    const labels = rows.map(r=>r.date);
    const data = rows.map(r=>r.sales);
    if(chart) chart.destroy();
    chart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Sales', data, tension:0.35, fill:false }] }, options:{ scales:{ y:{ beginAtZero:true } } } });
  }

  function save(){ localStorage.setItem('mod_kpi',JSON.stringify(rows)); renderChart(); }
  document.getElementById('addKPI').addEventListener('click', ()=>{ const d=document.getElementById('kpi_date').value, s=Number(document.getElementById('kpi_sales').value||0), p=Number(document.getElementById('kpi_profit').value||0), n=Number(document.getElementById('kpi_new').value||0); if(!d) return alert('Date'); rows.push({date:d,sales:s,profit:p,new:n}); save(); });
  document.getElementById('exportKPI').addEventListener('click', ()=>{ if(!rows.length) return alert('No data'); const csv='Date,Sales,Profit,New\\n'+rows.map(r=>`${r.date},${r.sales},${r.profit},${r.new}`).join('\\n'); const b=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='kpi.csv'; a.click(); });
  renderChart();
})();
</script>
